# PARSER VULNERABILITY ANALYSIS - Per Exchange

**Created**: 2025-11-24
**Question**: Is the trade stream failure happening to ALL exchanges, or just Bybit?

---

## ‚úÖ CRITICAL FINDING: VULNERABILITY IS **BYBIT-SPECIFIC**

The "topic missing ‚Üí silent drop" vulnerability exists **ONLY** in the Bybit trade parser.

Binance and OKX use completely different parser designs that do NOT have this vulnerability.

---

## PARSER COMPARISON

### üî¥ BYBIT - HAS VULNERABILITY

**File**: `barter-data/src/exchange/bybit/trade.rs`

**Design**: Two-stage conditional deserialization with `Ignore` variant

```rust
pub enum BybitTradeMessage {
    Ignore,             // ‚Üê Can silently drop messages
    Payload(BybitTrade),
}

impl<'de> Deserialize<'de> for BybitTradeMessage {
    fn deserialize<D>(deserializer: D) -> Result<Self, D::Error> {
        let value = Value::deserialize(deserializer)?;

        match value.get("topic") {
            Some(topic) if topic.is_string() => {
                // Deserialize payload
                ...
            }
            _ => Ok(BybitTradeMessage::Ignore),  // ‚Üê SILENT DROP!
        }
    }
}
```

**Vulnerability**:
- Custom deserializer checks for "topic" field **before** attempting deserialization
- If "topic" missing ‚Üí returns `BybitTradeMessage::Ignore`
- `Ignore` variant converts to empty vector ‚Üí **NO ERROR**
- Messages disappear silently

**When it triggers**:
- Bybit sends delta updates without "topic" field
- Bybit varies message format (snapshot vs delta)
- Any message missing or malformed "topic" field

---

### ‚úÖ BINANCE - NO VULNERABILITY

**File**: `barter-data/src/exchange/binance/trade.rs`

**Design**: Direct struct deserialization, no enum wrapper

```rust
#[derive(Clone, PartialEq, PartialOrd, Debug, Deserialize, Serialize)]
pub struct BinanceTrade {
    #[serde(alias = "s", deserialize_with = "de_trade_subscription_id")]
    pub subscription_id: SubscriptionId,
    #[serde(alias = "T", ...)]
    pub time: DateTime<Utc>,
    #[serde(alias = "t")]
    pub id: u64,
    #[serde(alias = "p", ...)]
    pub price: f64,
    #[serde(alias = "q", ...)]
    pub amount: f64,
    #[serde(alias = "m", ...)]
    pub side: Side,
}

// Direct conversion - no enum, no Ignore variant
impl From<(ExchangeId, InstrumentKey, BinanceTrade)> for MarketIter<...> {
    fn from((exchange_id, instrument, trade): ...) -> Self {
        Self(vec![Ok(MarketEvent { ... })])
    }
}
```

**Why it's safe**:
- **NO enum wrapper** - trades directly to struct
- **NO `Ignore` variant** - cannot silently drop
- **Direct deserialization** - serde handles all fields
- Missing fields cause **explicit deserialization errors**
- Errors propagate up (not swallowed)

**Required fields**:
- `s` (symbol) - REQUIRED
- `T` (time) - REQUIRED
- `t` (trade ID) - REQUIRED
- `p` (price) - REQUIRED
- `q` (quantity) - REQUIRED
- `m` (buyer_is_maker) - REQUIRED

If ANY field is missing ‚Üí serde returns `Err()`, not silent drop.

---

### ‚úÖ OKX - NO VULNERABILITY

**File**: `barter-data/src/exchange/okx/trade.rs`

**Design**: Message wrapper with direct deserialization

```rust
#[derive(Clone, Eq, PartialEq, Ord, PartialOrd, Hash, Debug, Deserialize, Serialize)]
pub struct OkxMessage<T> {
    #[serde(rename = "arg", deserialize_with = "de_okx_message_arg_as_subscription_id")]
    pub subscription_id: SubscriptionId,
    pub data: Vec<T>,  // ‚Üê Direct deserialization of trades
}

#[derive(Clone, PartialEq, PartialOrd, Debug, Deserialize, Serialize)]
pub struct OkxTrade {
    #[serde(rename = "tradeId")]
    pub id: String,
    #[serde(rename = "px", ...)]
    pub price: f64,
    #[serde(rename = "sz", ...)]
    pub amount: f64,
    pub side: Side,
    #[serde(rename = "ts", ...)]
    pub time: DateTime<Utc>,
}

// Direct conversion - no enum, no Ignore variant
impl From<(ExchangeId, InstrumentKey, OkxTrades)> for MarketIter<...> {
    fn from((exchange, instrument, trades): ...) -> Self {
        trades.data.into_iter().map(|trade| { ... }).collect()
    }
}
```

**Why it's safe**:
- **NO enum wrapper** - direct message struct
- **NO `Ignore` variant** - cannot silently drop
- **Wrapper pattern** - `OkxMessage<T>` contains trades
- Missing fields cause **explicit deserialization errors**
- Errors propagate up (not swallowed)

**Required fields** (in wrapper):
- `arg` (with `channel` and `instId`) - REQUIRED
- `data` (array of trades) - REQUIRED

**Required fields** (in trade):
- `tradeId` - REQUIRED
- `px` (price) - REQUIRED
- `sz` (size/amount) - REQUIRED
- `side` - REQUIRED
- `ts` (timestamp) - REQUIRED

If ANY field is missing ‚Üí serde returns `Err()`, not silent drop.

---

## WHY BYBIT USES THIS PATTERN

Looking at the Bybit code, the `Ignore` variant appears to be designed to handle non-trade messages:
- Subscription responses
- Heartbeat/pong messages
- Status updates

The problem is the **overly broad condition** for returning `Ignore`:
```rust
_ => Ok(BybitTradeMessage::Ignore),  // Catches EVERYTHING without "topic"
```

This catches:
- ‚úÖ Subscription responses (intended)
- ‚úÖ Heartbeats (intended)
- ‚ùå **Trade delta updates** (UNINTENDED!)
- ‚ùå **Any malformed but valid trade message** (UNINTENDED!)

---

## HISTORICAL EVIDENCE

### Trades Worked Initially (Nov 24 01:49-01:56)

From `server_debug.log`:
```
[2025-11-24T01:50:43] SPOT TRADE >=50k BinanceSpot btc/usdt @ 86695.47 qty 0.57813
[2025-11-24T01:51:52] SPOT TRADE >=50k BybitSpot btc/usdt @ 86758.3 qty 1.139399
[2025-11-24T01:51:52] SPOT TRADE >=50k Okx btc/usdt @ 86746.4 qty 0.94423272
```

**All three exchanges worked for spot trades!**

### After Restart - Current State

User report: "Zero trade messages from any exchange"

**Two possible explanations**:

1. **Bybit-specific** (95% probability):
   - Bybit messages now missing "topic" field ‚Üí silently dropped
   - Binance/OKX have **different issue** (subscription, deserialization error, or downstream)

2. **System-wide** (5% probability):
   - Server broadcast issue affecting all trades
   - TUI filtering issue
   - Subscription configuration error

---

## IF BINANCE/OKX ARE ALSO BROKEN

If Binance and OKX trades aren't appearing either, the causes would be **DIFFERENT**:

### Binance - Possible Issues (NOT silent drop)

1. **Deserialization error** (would show in logs):
   - Missing required field (`s`, `T`, `t`, `p`, `q`, `m`)
   - Malformed field (e.g., "m" is not boolean)
   - Wrong data type

2. **Subscription issue**:
   - Channel name wrong (should be `{symbol}@trade`)
   - WebSocket URL wrong
   - Subscription not acknowledged

3. **No messages arriving**:
   - WebSocket connection dropped
   - Exchange throttling
   - Network issue

**Key**: Binance errors would be **EXPLICIT**, not silent. Check logs for:
```bash
grep -i 'binance.*error\|binance.*deserial' server.log
```

### OKX - Possible Issues (NOT silent drop)

1. **Deserialization error** (would show in logs):
   - Missing `arg` field
   - Missing `data` field
   - Malformed trade objects

2. **Subscription issue**:
   - Channel wrong (should be `"trades"`)
   - `instId` wrong
   - Subscription not acknowledged

3. **No messages arriving**:
   - WebSocket connection dropped
   - Exchange throttling
   - Network issue

**Key**: OKX errors would be **EXPLICIT**, not silent. Check logs for:
```bash
grep -i 'okx.*error\|okx.*deserial' server.log
```

---

## DIAGNOSTIC LOGGING ADDED

I've added diagnostic logging to ALL THREE exchanges:

### Bybit Logging
- Shows every message received with trade data
- Reports if "topic" field exists (true/false)
- **Warns when message will be dropped** (missing topic)
- Shows full JSON of dropped messages
- Reports successful deserialization with trade count
- Shows trade details (symbol, price, qty, side)

### Binance Logging
- Shows when trade is converted to MarketEvent
- Reports trade details (subscription ID, price, qty, side)

### OKX Logging
- Shows when trades are converted to MarketEvents
- Reports trade count and details (ID, price, qty, side)

---

## WHAT THE DIAGNOSTIC WILL TELL US

After running `./run_diagnostic_capture.sh` for 5-10 minutes:

### Scenario A: Only Bybit Broken

```
üìä PER-EXCHANGE MESSAGE COUNTS:

  BYBIT:
    Trade debug messages: 250
    WITHOUT 'topic' field: 250      ‚Üê PROBLEM
    Dropped (Ignore): 250            ‚Üê PROBLEM
    Converted to MarketEvents: 0     ‚Üê PROBLEM

  BINANCE:
    Trade debug messages: 180        ‚Üê WORKING
    Converted to MarketEvents: 180   ‚Üê WORKING

  OKX:
    Trade debug messages: 150        ‚Üê WORKING
    Converted to MarketEvents: 150   ‚Üê WORKING
```

**Conclusion**: Bybit has the "topic missing" vulnerability. Binance and OKX work fine.

---

### Scenario B: All Exchanges Broken

```
üìä PER-EXCHANGE MESSAGE COUNTS:

  BYBIT:
    Trade debug messages: 250
    Dropped (Ignore): 250

  BINANCE:
    Trade debug messages: 0          ‚Üê NO MESSAGES
    Converted to MarketEvents: 0

  OKX:
    Trade debug messages: 0          ‚Üê NO MESSAGES
    Converted to MarketEvents: 0
```

**Conclusion**: Multiple issues:
1. Bybit: "topic missing" vulnerability
2. Binance/OKX: Subscription or connection problem (different root cause)

---

### Scenario C: All Exchanges Working

```
üìä PER-EXCHANGE MESSAGE COUNTS:

  BYBIT:
    Trade debug messages: 250
    Successfully deserialized: 250   ‚Üê WORKING
    Converted to MarketEvents: 250

  BINANCE:
    Trade debug messages: 180
    Converted to MarketEvents: 180

  OKX:
    Trade debug messages: 150
    Converted to MarketEvents: 150
```

**Conclusion**: Trades are parsing correctly. Issue is downstream (server broadcast or TUI).

---

## SUMMARY TABLE

| Exchange | Parser Design | Has `Ignore`? | Can Silent Drop? | If Broken, Likely Cause |
|----------|--------------|---------------|------------------|-------------------------|
| **Bybit** | Custom deserializer with conditional logic | YES | **YES** ‚ùå | Missing "topic" field ‚Üí silent drop |
| **Binance** | Direct struct deserialization | NO | NO ‚úÖ | Missing required field ‚Üí explicit error |
| **OKX** | Wrapper with direct deserialization | NO | NO ‚úÖ | Missing required field ‚Üí explicit error |

---

## ANSWER TO YOUR QUESTION

> "Why only happens the problem with Bybit? Or is the problem present with other exchanges, type of markets and tokens as well?"

**Answer**:

1. **The "topic missing ‚Üí silent drop" vulnerability is UNIQUE to Bybit**
   - Bybit parser has custom deserializer with `Ignore` variant
   - Binance and OKX use direct deserialization (no vulnerability)

2. **If Binance/OKX trades are also missing, the causes are DIFFERENT**:
   - Bybit: Silent drop (parser vulnerability)
   - Binance: Explicit deserialization error OR subscription issue
   - OKX: Explicit deserialization error OR subscription issue

3. **The diagnostic script will reveal the exact situation**:
   - Run for 5-10 minutes
   - Shows per-exchange message counts
   - Identifies which exchanges are affected
   - Shows different failure modes for each

4. **Historical evidence proves all three WORKED**:
   - Nov 24 01:49-01:56: Spot trades logged from all three
   - Something changed (likely Bybit message format variation)
   - May be one issue (Bybit) or multiple issues (all exchanges)

---

## NEXT STEP

**Run the diagnostic capture NOW** to get definitive evidence:

```bash
cd /Users/screener-m3/projects/barter-rs
./run_diagnostic_capture.sh
```

Let it run for 5-10 minutes, then press ENTER.

The script will automatically:
1. Show per-exchange message counts
2. Identify which exchanges are affected
3. Show failure modes (silent drop vs explicit error vs no messages)
4. Recommend specific fixes for each exchange

**This will answer definitively whether the problem is Bybit-only or all exchanges.**
